<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="{{.webPath}}static/common.css">
    <style>
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--win11-bg);
            color: var(--win11-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--win11-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--win11-shadow);
            border: 1px solid var(--win11-border);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h1 {
            color: var(--win11-text-primary);
            text-align: center;
            font-weight: 600;
        }

        .auth-section {
            text-align: right;
            margin-bottom: 20px;
        }

        .auth-section a {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--win11-success);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .auth-section a.logout {
            background-color: var(--win11-danger);
        }

        .auth-section a:hover {
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--win11-text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 4px;
            color: var(--win11-text-primary);
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--win11-accent);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            resize: vertical;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--win11-accent);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: var(--win11-accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            background-color: var(--win11-accent-active);
            transform: translateY(0);
        }

        .btn-success {
            background-color: var(--win11-success);
        }

        .btn-success:hover {
            background-color: #57a357;
        }

        .btn-warning {
            background-color: var(--win11-warning);
            color: #000000;
        }

        .btn-warning:hover {
            background-color: #e6b800;
        }

        .btn-danger {
            background-color: var(--win11-danger);
        }

        .btn-danger:hover {
            background-color: #c40f1d;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 13px;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            transition: all 0.3s;
            animation: fadeIn 0.3s;
        }

        .alert-success {
            background-color: rgba(102, 194, 102, 0.2);
            color: var(--win11-success);
            border: 1px solid var(--win11-success);
        }

        .alert-danger {
            background-color: rgba(232, 17, 35, 0.2);
            color: var(--win11-danger);
            border: 1px solid var(--win11-danger);
        }

        .domainmap-card {
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .domainmap-card:hover {
            background-color: var(--win11-surface);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--win11-shadow);
        }

        .domainmap-card h3 {
            margin-top: 0;
            color: var(--win11-text-primary);
            border-bottom: 1px solid var(--win11-border);
            padding-bottom: 8px;
        }

        .domainmap-card p {
            margin: 8px 0;
            color: var(--win11-text-secondary);
        }

        .domainmap-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--win11-border);
        }

        .domainmap-item-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--win11-text-primary);
        }

        .subsection {
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .subsection-title {
            margin-top: 0;
            color: var(--win11-text-primary);
            border-bottom: 1px solid var(--win11-border);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.5);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #list-view,
        #detail-view {
            margin-top: 20px;
        }

        #detail-view {
            display: none;
        }

        .proxy-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--win11-border);
            border-radius: 4px;
            padding: 10px;
            background-color: var(--win11-card);
        }

        .proxy-item {
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .proxy-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .proxy-item-title {
            font-weight: 600;
            color: var(--win11-accent);
        }

        .btn-group-sm {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: var(--win11-surface);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--win11-border);
            border-radius: 6px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: var(--win11-text-primary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--win11-border);
        }

        .modal-title {
            margin: 0;
            color: var(--win11-text-primary);
            font-size: 18px;
        }

        .close {
            color: var(--win11-text-tertiary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--win11-text-primary);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .header-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-item input {
            flex: 1;
        }

        .header-actions button {
            background-color: var(--win11-danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        .header-actions button:hover {
            background-color: #c40f1d;
        }

        .domain-input-container {
            display: flex;
            margin-bottom: 5px;
        }

        .domain-input {
            flex: 1;
            margin-right: 10px;
        }

        .domain-remove-btn {
            background-color: var(--win11-danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        .domain-remove-btn:hover {
            background-color: #c40f1d;
        }

        .add-domain-btn {
            background-color: var(--win11-success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            margin-top: 5px;
            transition: background-color 0.3s;
        }

        .add-domain-btn:hover {
            background-color: #57a357;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
    <script src="{{.webPath}}static/js/theme.js"></script>
</head>

<body>
    <div class="container">
        <h1>{{.title}}</h1>

        <div class="auth-section">
            <a href="{{.webPath}}" class="btn">返回首页</a>
            <a href="javascript:void(0)" class="btn logout" onclick="logout()">退出登录</a>
        </div>

        <!-- 提示信息区域 -->
        <div id="alert-container" class="alert hidden" role="alert"></div>

        <!-- 列表视图 -->
        <div id="list-view">
            <div class="form-buttons">
                <button class="btn btn-success" onclick="showAddProxyGroupModal()">添加代理组</button>
                <button class="btn" onclick="loadConfig()">重新加载</button>
                <button class="btn btn-primary" onclick="saveConfig()">保存配置</button>
            </div>

            <div class="grid" id="proxygroups-list">
                <!-- 代理组列表将在这里动态生成 -->
            </div>
        </div>

        <!-- 添加/编辑代理组模态框 -->
        <div id="proxyGroupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="proxyGroupModalTitle">添加代理组</h2>
                    <span class="close" onclick="closeProxyGroupModal()">&times;</span>
                </div>
                <input type="hidden" id="editProxyGroupName">
                <div class="form-group">
                    <label for="proxyGroupName">组名称:</label>
                    <input type="text" id="proxyGroupName" class="form-control" placeholder="输入代理组名称">
                </div>
                <div class="form-group">
                    <label for="loadbalance">负载均衡:</label>
                    <select id="loadbalance" class="form-control">
                        <option value="round-robin">轮询 (round-robin)</option>
                        <option value="fastest">最快响应 (fastest)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="interval">检查间隔:</label>
                    <input type="text" id="interval" class="form-control" placeholder="例如: 180s, 1m" value="180s">
                </div>
                <div class="form-group">
                    <label for="max_retries">最大重试次数:</label>
                    <input type="number" id="max_retries" class="form-control" value="1" min="0">
                </div>
                <div class="form-group">
                    <label for="retry_delay">重试延迟:</label>
                    <input type="text" id="retry_delay" class="form-control" placeholder="例如: 1s, 5s" value="1s">
                </div>
                <div class="form-group">
                    <label for="max_rt">最大响应时间:</label>
                    <input type="text" id="max_rt" class="form-control" placeholder="例如: 200ms, 5s" value="200ms">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="ipv6">
                    <label for="ipv6">启用IPv6</label>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">域名规则</h3>
                    <div id="domains-container">
                        <div class="empty-message">暂无域名规则</div>
                    </div>
                    <button class="add-domain-btn" onclick="addDomainField()">添加域名规则</button>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">代理服务器
                        <button class="btn btn-sm btn-success" style="float: right;"
                            onclick="showAddProxyModal()">添加代理</button>
                    </h3>
                    <div id="proxy-list" class="proxy-list">
                        <div class="empty-message">暂无代理服务器</div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn cancel" onclick="closeProxyGroupModal()">取消</button>
                    <button class="btn save" id="saveProxyGroupBtn">添加</button>
                </div>
            </div>
        </div>

        <!-- 添加/编辑代理服务器模态框 -->
        <div id="proxyModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="proxyModalTitle">添加代理服务器</h2>
                    <span class="close" onclick="closeProxyModal()">&times;</span>
                </div>
                <input type="hidden" id="proxyEditIndex">
                <div class="form-group">
                    <label for="proxyName">代理名称:</label>
                    <input type="text" id="proxyName" class="form-control" placeholder="输入代理名称">
                </div>
                <div class="form-group">
                    <label for="proxyType">代理类型:</label>
                    <select id="proxyType" class="form-control" onchange="toggleHeadersField()">
                        <option value="socks5">SOCKS5</option>
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="socks4">SOCKS4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="proxyServer">服务器地址:</label>
                    <input type="text" id="proxyServer" class="form-control"
                        placeholder="例如: 127.0.0.1 或 proxy.example.com">
                </div>
                <div class="form-group">
                    <label for="proxyPort">端口:</label>
                    <input type="number" id="proxyPort" class="form-control" placeholder="例如: 8080" min="1" max="65535">
                </div>
                <div class="form-group checkbox-group hidden" id="proxyUDPField">
                    <input type="checkbox" id="proxyUDP">
                    <label for="proxyUDP">启用UDP (仅SOCKS5)</label>
                </div>
                <div class="form-group">
                    <label for="proxyUsername">用户名 (可选):</label>
                    <input type="text" id="proxyUsername" class="form-control">
                </div>
                <div class="form-group">
                    <label for="proxyPassword">密码 (可选):</label>
                    <input type="password" id="proxyPassword" class="form-control">
                </div>
                <div class="form-group hidden" id="proxyHeadersField">
                    <label>Headers (可选):</label>
                    <div id="proxyHeadersContainer"></div>
                    <button type="button" class="add-domain-btn" onclick="addHeaderField()">添加Header</button>
                </div>
                <div class="btn-group">
                    <button class="btn cancel" onclick="closeProxyModal()">取消</button>
                    <button class="btn save" id="saveProxyBtn" onclick="saveProxy()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const webPath = "{{.webPath}}";
        window.webPath = webPath; // 设为全局变量供theme.js使用
        // console.log('webPath:', webPath);
        let proxyGroups = {};

        // 页面加载完成后获取配置
        window.addEventListener('load', function () {
            // console.log('页面加载完成，开始加载配置');
            loadConfig();
        });

        // 显示提示信息
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.className = `alert alert-${type}`;
            alertContainer.innerHTML = message;
            alertContainer.classList.remove('hidden');

            // 5秒后自动隐藏（给用户更多时间看到成功消息）
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }

        // 加载配置
        function loadConfig() {
            // console.log('开始加载配置，URL:', webPath + 'config/proxygroups');
            return fetch(webPath + 'config/proxygroups')
                .then(response => {
                    // console.log('收到响应:', response);
                    if (!response.ok) {
                        throw new Error('加载配置失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('加载到的配置数据:', data);
                    proxyGroups = data || {};
                    renderProxyGroupList();
                })
                .catch(error => {
                    console.error('加载配置失败:', error);
                    showAlert('加载配置失败: ' + error.message, 'danger');
                });
        }

        // 渲染代理组列表
        function renderProxyGroupList() {
            const container = document.getElementById('proxygroups-list');
            container.innerHTML = '';

            // 渲染每个代理组项为卡片
            Object.keys(proxyGroups).forEach(name => {
                const cardElement = createProxyGroupCard(name, proxyGroups[name]);
                container.appendChild(cardElement);
            });

            // console.log('渲染完成，当前代理组:', proxyGroups);
        }

        // 创建代理组卡片元素
        function createProxyGroupCard(name, proxyGroup) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'domainmap-card';
            cardDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">${name || '未命名'}</h3>
                    <button class="btn btn-sm btn-danger" style="margin-left: auto;" onclick="deleteProxyGroup('${name}')">删除</button>
                </div>
                <p><strong>负载均衡:</strong> ${proxyGroup.loadbalance || '未设置'}</p>
                <p><strong>检查间隔:</strong> ${proxyGroup.interval || '未设置'}</p>
                <p><strong>域名规则:</strong> ${(proxyGroup.domains && proxyGroup.domains.length) || 0} 条规则</p>
                <p><strong>代理服务器:</strong> ${(proxyGroup.proxies && proxyGroup.proxies.length) || 0} 个</p>
            `;
            cardDiv.onclick = function (e) {
                // 如果点击的是删除按钮，不触发编辑
                if (e.target.closest('.btn')) return;
                showEditProxyGroupModal(name);
            };
            return cardDiv;
        }

        // 显示添加代理组模态框
        function showAddProxyGroupModal() {
            // 清空表单
            document.getElementById('editProxyGroupName').value = '';
            document.getElementById('proxyGroupName').value = '';
            document.getElementById('proxyGroupName').readOnly = false;
            document.getElementById('loadbalance').value = 'round-robin';
            document.getElementById('interval').value = '180s';
            document.getElementById('max_retries').value = '1';
            document.getElementById('retry_delay').value = '1s';
            document.getElementById('max_rt').value = '200ms';
            document.getElementById('ipv6').checked = false;

            // 清空域名和代理列表
            document.getElementById('domains-container').innerHTML = '<div class="empty-message">暂无域名规则</div>';
            document.getElementById('proxy-list').innerHTML = '<div class="empty-message">暂无代理服务器</div>';

            // 设置标题和按钮文本
            document.getElementById('proxyGroupModalTitle').textContent = '添加代理组';
            document.getElementById('saveProxyGroupBtn').textContent = '添加';
            document.getElementById('saveProxyGroupBtn').onclick = addProxyGroup;

            // 显示模态框
            document.getElementById('proxyGroupModal').style.display = 'block';
        }

        // 显示编辑代理组模态框
        function showEditProxyGroupModal(name) {
            const proxyGroup = proxyGroups[name];

            // 填充表单
            document.getElementById('editProxyGroupName').value = name;
            document.getElementById('proxyGroupName').value = name;
            document.getElementById('proxyGroupName').readOnly = true;
            document.getElementById('loadbalance').value = proxyGroup.loadbalance || 'round-robin';
            document.getElementById('interval').value = proxyGroup.interval || '180s';
            document.getElementById('max_retries').value = proxyGroup.max_retries || 1;
            document.getElementById('retry_delay').value = proxyGroup.retry_delay || '1s';
            document.getElementById('max_rt').value = proxyGroup.max_rt || '200ms';
            document.getElementById('ipv6').checked = proxyGroup.ipv6 || false;

            // 渲染域名规则
            renderDomainFields(proxyGroup.domains || []);

            // 渲染代理服务器列表
            renderProxyList(proxyGroup.proxies || []);

            // 确保代理组卡片显示更新
            updateProxyGroupCardProxyCount(name);

            // 设置标题和按钮文本
            document.getElementById('proxyGroupModalTitle').textContent = '编辑代理组';
            document.getElementById('saveProxyGroupBtn').textContent = '保存';
            document.getElementById('saveProxyGroupBtn').onclick = function () {
                updateProxyGroup(name);
            };

            // 显示模态框
            document.getElementById('proxyGroupModal').style.display = 'block';
        }

        // 关闭代理组模态框
        function closeProxyGroupModal() {
            document.getElementById('proxyGroupModal').style.display = 'none';
        }

        // 渲染域名规则字段
        function renderDomainFields(domains) {
            const container = document.getElementById('domains-container');
            container.innerHTML = '';

            if (!domains || domains.length === 0) {
                container.innerHTML = '<div class="empty-message">暂无域名规则</div>';
                return;
            }

            domains.forEach((domain, index) => {
                const domainDiv = document.createElement('div');
                domainDiv.className = 'domain-input-container';
                domainDiv.innerHTML = `
                    <input type="text" class="form-control domain-input" value="${domain}">
                    <button class="domain-remove-btn" onclick="removeDomainField(this)">删除</button>
                `;
                container.appendChild(domainDiv);
            });
        }

        // 添加域名规则字段
        function addDomainField() {
            const container = document.getElementById('domains-container');
            // 如果是空消息，先清空
            if (container.querySelector('.empty-message')) {
                container.innerHTML = '';
            }

            const domainDiv = document.createElement('div');
            domainDiv.className = 'domain-input-container';
            domainDiv.innerHTML = `
                <input type="text" class="form-control domain-input" placeholder="例如: *.example.com 或 192.168.1.0/24">
                <button class="domain-remove-btn" onclick="removeDomainField(this)">删除</button>
            `;
            container.appendChild(domainDiv);
        }

        // 删除域名规则字段
        function removeDomainField(button) {
            const domainItem = button.closest('.domain-input-container');
            if (domainItem) {
                domainItem.remove();

                // 如果没有域名规则了，显示空消息
                const container = document.getElementById('domains-container');
                if (container.children.length === 0) {
                    container.innerHTML = '<div class="empty-message">暂无域名规则</div>';
                }
            }
        }

        // 渲染代理服务器列表
        function renderProxyList(proxies) {
            const container = document.getElementById('proxy-list');
            container.innerHTML = '';

            // if (!proxies || proxies.length === 0) {
            //     container.innerHTML = '<div class="empty-message">暂无代理服务器</div>';
            //     return;
            // }

            proxies.forEach((proxy, index) => {
                const proxyDiv = document.createElement('div');
                proxyDiv.className = 'proxy-item';
                proxyDiv.innerHTML = `
                    <div class="proxy-item-header">
                        <span class="proxy-item-title">${proxy.name || '未命名'}</span>
                        <div class="btn-group-sm">
                            <button class="btn btn-sm btn-warning" onclick="showEditProxyModal(${index})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="removeProxyServer(${index})">删除</button>
                        </div>
                    </div>
                    <p><strong>类型:</strong> ${proxy.type || ''}</p>
                    <p><strong>地址:</strong> ${proxy.server || ''}:${proxy.port || ''}</p>
                    ${proxy.username ? `<p><strong>用户名:</strong> ${proxy.username}</p>` : ''}
                    ${proxy.headers ? `<p><strong>Headers:</strong> ${Object.keys(proxy.headers).length} 个</p>` : ''}
                `;
                container.appendChild(proxyDiv);
            });
        }

        // 显示添加代理模态框
        function showAddProxyModal() {
            // 清空表单
            document.getElementById('proxyEditIndex').value = '';
            document.getElementById('proxyName').value = '';
            document.getElementById('proxyType').value = 'socks5';
            document.getElementById('proxyServer').value = '';
            document.getElementById('proxyPort').value = '';
            document.getElementById('proxyUDP').checked = false;
            document.getElementById('proxyUsername').value = '';
            document.getElementById('proxyPassword').value = '';

            // 清空并隐藏headers容器
            document.getElementById('proxyHeadersContainer').innerHTML = '';
            document.getElementById('proxyHeadersField').classList.add('hidden');
            document.getElementById('proxyUDPField').classList.remove('hidden');

            // 调用toggleHeadersField以确保UI正确更新
            toggleHeadersField();

            // 设置标题和按钮文本
            document.getElementById('proxyModalTitle').textContent = '添加代理服务器';
            document.getElementById('saveProxyBtn').textContent = '添加';
            document.getElementById('saveProxyBtn').onclick = addProxy;

            // 显示模态框
            document.getElementById('proxyModal').style.display = 'block';
        }

        // 显示编辑代理模态框
        function showEditProxyModal(index) {
            const proxy = getCurrentProxies()[index];

            // 填充表单
            document.getElementById('proxyEditIndex').value = index;
            document.getElementById('proxyName').value = proxy.name || '';
            document.getElementById('proxyType').value = proxy.type || 'socks5';
            document.getElementById('proxyServer').value = proxy.server || '';
            document.getElementById('proxyPort').value = proxy.port || '';
            document.getElementById('proxyUDP').checked = proxy.udp || false;
            document.getElementById('proxyUsername').value = proxy.username || '';
            document.getElementById('proxyPassword').value = proxy.password || '';

            // 处理headers
            const headersContainer = document.getElementById('proxyHeadersContainer');
            headersContainer.innerHTML = '';

            if (proxy.headers && Object.keys(proxy.headers).length > 0) {
                Object.keys(proxy.headers).forEach(key => {
                    const value = proxy.headers[key];
                    addHeaderField(key, value);
                });
            }

            // 根据代理类型显示相应的字段
            toggleHeadersField();

            // 设置标题和按钮文本
            document.getElementById('proxyModalTitle').textContent = '编辑代理服务器';
            document.getElementById('saveProxyBtn').textContent = '保存';
            document.getElementById('saveProxyBtn').onclick = updateProxy;

            // 显示模态框
            document.getElementById('proxyModal').style.display = 'block';
        }

        // 关闭代理模态框
        function closeProxyModal() {
            document.getElementById('proxyModal').style.display = 'none';
        }

        // 根据代理类型切换显示字段
        function toggleHeadersField() {
            const proxyType = document.getElementById('proxyType').value;
            const headersField = document.getElementById('proxyHeadersField');
            const udpField = document.getElementById('proxyUDPField');

            // http/https 显示headers选项
            if (proxyType === 'http' || proxyType === 'https') {
                headersField.classList.remove('hidden');
                udpField.classList.add('hidden');
            }
            // socks5 显示UDP选项
            else if (proxyType === 'socks5') {
                headersField.classList.add('hidden');
                udpField.classList.remove('hidden');
            }
            // 其他类型隐藏两个选项
            else {
                headersField.classList.add('hidden');
                udpField.classList.add('hidden');
            }
        }

        // 添加Header字段
        function addHeaderField(key = '', value = '') {
            const container = document.getElementById('proxyHeadersContainer');
            const headerItem = document.createElement('div');
            headerItem.className = 'header-item';
            headerItem.innerHTML = `
                <input type="text" class="form-control" placeholder="Header名称" value="${key}">
                <input type="text" class="form-control" placeholder="Header值" value="${value}">
                <div class="header-actions">
                    <button type="button" onclick="removeHeaderField(this)">-</button>
                </div>
            `;
            container.appendChild(headerItem);
        }

        // 删除Header字段
        function removeHeaderField(button) {
            const headerItem = button.closest('.header-item');
            if (headerItem) {
                headerItem.remove();
            }
        }

        // 获取当前代理组的代理服务器列表
        function getCurrentProxies() {
            const editName = document.getElementById('editProxyGroupName').value;
            if (editName && proxyGroups[editName]) {
                return proxyGroups[editName].proxies || [];
            }
            return [];
        }

        // 添加代理服务器
        function addProxy() {
            const name = document.getElementById('proxyName').value.trim();
            const type = document.getElementById('proxyType').value;
            const server = document.getElementById('proxyServer').value.trim();
            const port = parseInt(document.getElementById('proxyPort').value) || 80; // 默认端口 80
            const udp = document.getElementById('proxyUDP').checked;
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value;

            if (!name || !server) {
                showAlert('请填写代理名称和服务器地址', 'danger');
                return;
            }

            const proxy = { name, type, server, port };
            if (type === 'socks5' && udp) proxy.udp = true;
            if (username) proxy.username = username;
            if (password) proxy.password = password;

            // http/https headers
            if ((type === 'http' || type === 'https') &&
                document.querySelectorAll('#proxyHeadersContainer .header-item').length > 0) {
                proxy.headers = {};
                const headerItems = document.querySelectorAll('#proxyHeadersContainer .header-item');
                headerItems.forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        proxy.headers[key] = value;
                    }
                });
                if (Object.keys(proxy.headers).length === 0) {
                    delete proxy.headers;
                }
            }

            const groupName = getCurrentEditGroupName();
            if (!groupName) {
                showAlert('请先输入代理组名称', 'danger');
                return;
            }

            // 确保代理组存在
            if (!proxyGroups[groupName]) {
                proxyGroups[groupName] = { 
                    proxies: [], 
                    domains: [],
                    loadbalance: 'round-robin',
                    interval: '180s',
                    max_retries: 1,
                    retry_delay: '1s',
                    max_rt: '200ms',
                    ipv6: false
                };
            }
            
            // 确保proxies数组存在
            if (!proxyGroups[groupName].proxies) {
                proxyGroups[groupName].proxies = [];
            }
            
            proxyGroups[groupName].proxies.push(proxy);

            renderProxyList(proxyGroups[groupName].proxies);
            updateProxyGroupCardProxyCount(groupName);

            closeProxyModal();
            showAlert('代理服务器添加成功，请点击"保存配置"按钮保存更改', 'success');
        }

        // 更新代理组卡片中的代理服务器数量显示
        function updateProxyGroupCardProxyCount(proxyGroupName) {
            // 使用原生JavaScript替代:contains选择器
            const cards = document.querySelectorAll('.domainmap-card');
            let targetCard = null;

            // 遍历所有卡片找到匹配的组名
            for (let i = 0; i < cards.length; i++) {
                const h3 = cards[i].querySelector('h3');
                if (h3 && h3.textContent.trim() === proxyGroupName) {
                    targetCard = cards[i];
                    break;
                }
            }

            if (targetCard) {
                const proxyCountElements = targetCard.querySelectorAll('p');
                for (let i = 0; i < proxyCountElements.length; i++) {
                    if (proxyCountElements[i].textContent.includes('代理服务器')) {
                        // 更新代理服务器数量
                        const proxyCount = proxyGroups[proxyGroupName].proxies.length;
                        proxyCountElements[i].innerHTML = `<strong>代理服务器:</strong> ${proxyCount} 个`;
                        break;
                    }
                }
            }
        }

        // 删除代理组
        function deleteProxyGroup(name) {
            if (confirm("确定要删除这个代理组吗？")) {
                delete proxyGroups[name];
                renderProxyGroupList();
                showAlert('代理组已删除，请点击"保存配置"按钮保存更改', 'success');
            }
        }

        // 更新代理服务器
        function updateProxy() {
            const index = parseInt(document.getElementById('proxyEditIndex').value);
            const name = document.getElementById('proxyName').value.trim();
            const type = document.getElementById('proxyType').value;
            const server = document.getElementById('proxyServer').value.trim();
            const port = parseInt(document.getElementById('proxyPort').value) || 80;
            const udp = document.getElementById('proxyUDP').checked;
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value;

            if (!name || !server) {
                showAlert('请填写代理名称和服务器地址', 'danger');
                return;
            }

            const proxy = { name, type, server, port };
            if (type === 'socks5' && udp) proxy.udp = true;
            if (username) proxy.username = username;
            if (password) proxy.password = password;

            if ((type === 'http' || type === 'https') &&
                document.querySelectorAll('#proxyHeadersContainer .header-item').length > 0) {
                proxy.headers = {};
                const headerItems = document.querySelectorAll('#proxyHeadersContainer .header-item');
                headerItems.forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        proxy.headers[key] = value;
                    }
                });
                if (Object.keys(proxy.headers).length === 0) {
                    delete proxy.headers;
                }
            }

            const groupName = getCurrentEditGroupName();
            if (groupName && proxyGroups[groupName] && proxyGroups[groupName].proxies) {
                proxyGroups[groupName].proxies[index] = proxy;
                renderProxyList(proxyGroups[groupName].proxies);
                updateProxyGroupCardProxyCount(groupName);
            }

            closeProxyModal();
            showAlert('代理服务器更新成功，请点击"保存配置"按钮保存更改', 'success');
        }

        // 获取当前正在编辑/新建的代理组名
        function getCurrentEditGroupName() {
            // 首先尝试从隐藏字段获取编辑中的代理组名称
            let editName = document.getElementById('editProxyGroupName');
            if (editName && editName.value.trim()) {
                return editName.value.trim();
            }
            
            // 如果隐藏字段为空，则尝试从代理组名称输入框获取
            let groupNameInput = document.getElementById('proxyGroupName');
            if (groupNameInput && groupNameInput.value.trim()) {
                return groupNameInput.value.trim();
            }
            
            // 如果都获取不到，返回空字符串
            return '';
        }

        // 删除代理服务器
        function removeProxyServer(index) {
            const editName = getCurrentEditGroupName();

            // console.log('当前编辑的代理组名称:', editName);
            // console.log('删除前的proxyGroups:', proxyGroups);

            if (editName && proxyGroups[editName] && proxyGroups[editName].proxies) {
                if (confirm("确定要删除这个代理服务器吗？")) {
                    proxyGroups[editName].proxies.splice(index, 1);

                    // console.log('删除后的proxyGroups:', proxyGroups);

                    // 更新当前代理组的代理服务器列表显示
                    renderProxyList(proxyGroups[editName].proxies);

                    // 更新代理组卡片显示的代理服务器数量
                    updateProxyGroupCardProxyCount(editName);

                    showAlert('代理服务器已删除，请点击"保存配置"按钮保存更改', 'success');
                }
            } else {
                // console.log('无法找到当前编辑的代理组，代理服务器未删除');
                showAlert('无法找到当前编辑的代理组，代理服务器未删除', 'danger');
            }
        }

        // 添加代理组
        function addProxyGroup() {
            const name = document.getElementById('proxyGroupName').value.trim();

            // if (proxyGroups[name]) {
            //     showAlert('代理组名称已存在', 'danger');
            //     return;
            // }

            // 收集表单数据，提供默认值
            const loadbalance = document.getElementById('loadbalance').value || 'round-robin';
            const interval = document.getElementById('interval').value || '180s';
            const maxRetries = parseInt(document.getElementById('max_retries').value) || 1;
            const retryDelay = document.getElementById('retry_delay').value || '1s';
            const maxRt = document.getElementById('max_rt').value || '200ms';
            const ipv6 = document.getElementById('ipv6').checked;

            // console.log('收集到的表单数据:', {
            //     loadbalance,
            //     interval,
            //     maxRetries,
            //     retryDelay,
            //     maxRt,
            //     ipv6
            // });

            // 收集域名规则
            const domains = [];
            const domainInputs = document.querySelectorAll('#domains-container .domain-input');
            domainInputs.forEach(input => {
                const domain = input.value.trim();
                if (domain) {
                    domains.push(domain);
                }
            });

            // console.log('收集到的域名规则:', domains);

            // 获取当前代理列表
            let currentProxies = [];
            const editName = getCurrentEditGroupName();
            if (editName && proxyGroups[editName] && proxyGroups[editName].proxies) {
                currentProxies = proxyGroups[editName].proxies;
            }

            // 确保初始化proxies数组
            proxyGroups[name] = {
                proxies: currentProxies,  // 使用当前代理列表而不是空数组
                domains: domains,
                ipv6: ipv6,
                interval: interval,
                loadbalance: loadbalance,
                max_retries: maxRetries,
                retry_delay: retryDelay,
                max_rt: maxRt
            };

            // console.log('添加的代理组数据:', proxyGroups[name]);
            // console.log('当前所有代理组:', proxyGroups);

            renderProxyGroupList();
            // console.log('代理组列表已重新渲染');
            showAlert('代理组添加成功，请点击"保存配置"按钮保存更改', 'success');
            // console.log('即将关闭代理组模态框');
            closeProxyGroupModal();
            // console.log('代理组模态框已关闭');
            // 不再立即保存到后端，只保存在前端
            // 用户需要点击页面顶部的保存按钮来保存所有更改
        }

        // 更新代理组
        function updateProxyGroup(oldName) {
            const name = document.getElementById('proxyGroupName').value.trim();

            if (!name) {
                showAlert('请输入代理组名称', 'danger');
                return;
            }

            const loadbalance = document.getElementById('loadbalance').value || 'round-robin';
            const interval = document.getElementById('interval').value || '180s';
            const maxRetries = parseInt(document.getElementById('max_retries').value) || 1;
            const retryDelay = document.getElementById('retry_delay').value || '1s';
            const maxRt = document.getElementById('max_rt').value || '200ms';
            const ipv6 = document.getElementById('ipv6').checked;

            const domains = [];
            const domainInputs = document.querySelectorAll('#domains-container .domain-input');
            domainInputs.forEach(input => {
                const domain = input.value.trim();
                if (domain) {
                    domains.push(domain);
                }
            });

            // 如果名称改变
            if (oldName !== name) {
                if (proxyGroups[name]) {
                    showAlert('代理组名称已存在', 'danger');
                    return;
                }
                delete proxyGroups[oldName];
            }

            const existingProxies = (proxyGroups[oldName] && proxyGroups[oldName].proxies) || [];

            proxyGroups[name] = {
                proxies: existingProxies,
                domains: domains,
                ipv6: ipv6,
                interval: interval,
                loadbalance: loadbalance,
                max_retries: maxRetries,
                retry_delay: retryDelay,
                max_rt: maxRt
            };

            closeProxyGroupModal();
            renderProxyGroupList();
            showAlert('代理组更新成功，请点击"保存配置"按钮保存更改', 'success');

            // 不再立即保存到后端，只保存在前端
            // 用户需要点击页面顶部的保存按钮来保存所有更改
        }

        // 保存配置
        function saveConfig() {
            // console.log('开始保存配置');
            // 验证必填字段
            let valid = true;
            let errorMsg = '';

            Object.keys(proxyGroups).forEach((name, index) => {
                const pg = proxyGroups[name];

                // 检查代理组名称
                if (!name) {
                    valid = false;
                    errorMsg = `代理组 #${index + 1} 的名称不能为空`;
                    return;
                }

                // 检查代理服务器
                if (pg.proxies && pg.proxies.length > 0) {
                    for (let i = 0; i < pg.proxies.length; i++) {
                        const proxy = pg.proxies[i];
                        if (!proxy.name || !proxy.server || !proxy.port) {
                            valid = false;
                            errorMsg = `代理组 "${name}" 中的代理服务器 #${i + 1} 的名称、服务器地址和端口不能为空`;
                            return;
                        }
                    }
                }
            });

            if (!valid) {
                showAlert(errorMsg, 'danger');
                return;
            }

            // 准备要发送的数据
            const cleanProxyGroups = {};
            Object.keys(proxyGroups).forEach(name => {
                const pg = proxyGroups[name];
                // 创建一个深拷贝以避免修改原始数据
                const cleaned = JSON.parse(JSON.stringify(pg));
                cleanProxyGroups[name] = cleaned;
            });

            // console.log('准备发送的数据:', cleanProxyGroups);

            // 检查是否有数据
            if (Object.keys(cleanProxyGroups).length === 0) {
                showAlert('没有数据需要保存', 'warning');
                return;
            }

            fetch(webPath + 'config/save-proxygroups', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cleanProxyGroups)
            })
                .then(response => {
                    // console.log('收到响应:', response);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || '保存失败');
                        });
                    }
                    return response.text();
                })
                .then(data => {
                    // console.log('保存成功:', data);
                    showAlert('配置保存成功,点击重新加载', 'success');
                    // 保存成功后刷新列表
                    return loadConfig();
                })
                .then(() => {
                    // console.log('配置重新加载完成');
                })
                .catch(error => {
                    console.error('保存配置失败:', error);
                    showAlert('保存配置失败: ' + error.message, 'danger');
                });
        }

        // 删除代理组
        function removeProxyGroup(name) {
            deleteProxyGroup(name);
        }


        // 退出登录
        function logout() {
            if (hasUnsavedChanges()) {
                if (!confirm('有未保存的更改，确定要退出登录吗？')) {
                    return;
                }
            }

            fetch(webPath + 'logout', {
                method: 'POST'
            })
                .then(() => {
                    window.location.href = webPath + 'login';
                })
                .catch(error => {
                    console.error('退出登录失败:', error);
                    window.location.href = webPath + 'login';
                });
        }

        // 检查是否有未保存的更改
        function hasUnsavedChanges() {
            // 这里简化处理，实际应该比较原始数据和当前数据
            return true;
        }

        // 点击模态框外部关闭
        window.onclick = function (event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        function saveProxyGroup() {
            // console.log('saveProxyGroup function called');
            // 获取表单数据
            const groupName = document.getElementById('proxyGroupName').value;
            const loadbalance = document.getElementById('loadbalance').value;
            const interval = document.getElementById('interval').value;
            const maxRetries = document.getElementById('max_retries').value;
            const retryDelay = document.getElementById('retry_delay').value;
            const maxRT = document.getElementById('max_rt').value;
            const ipv6 = document.getElementById('ipv6').checked;

            // 打印获取的数据
            // console.log('Group Name:', groupName);
            // console.log('Load Balance:', loadbalance);
            // console.log('Interval:', interval);
            // console.log('Max Retries:', maxRetries);
            // console.log('Retry Delay:', retryDelay);
            // console.log('Max RT:', maxRT);
            // console.log('IPv6 Enabled:', ipv6);

            // 这里可以添加保存数据的逻辑，例如发送 AJAX 请求等
            // 示例：
            // sendDataToServer({ groupName, loadbalance, interval, maxRetries, retryDelay, maxRT, ipv6 });
        }
    </script>
</body>

</html>