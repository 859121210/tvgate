<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>域名映射编辑器 - TVGate Web管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
        }

        h1 {
            color: #ffffff;
            text-align: center;
        }

        .auth-section {
            text-align: right;
            margin-bottom: 20px;
        }

        .auth-section a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: #ffffff;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .auth-section a.logout {
            background-color: #dc3545;
        }

        .auth-section a:hover {
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffffff;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            box-sizing: border-box;
        }

        textarea.form-control {
            min-height: 300px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: #ffffff;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #bd2130;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }

        .form-buttons {
            text-align: center;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .domainmap-item {
            background-color: #2c2c2c;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .domainmap-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .domainmap-item-title {
            font-weight: bold;
            color: #ffffff;
        }

        .add-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #28a745;
            color: #ffffff;
            text-align: center;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .add-btn:hover {
            background-color: #1e7e34;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.5);
        }

        .subsection {
            background-color: #3a3a3a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .subsection-title {
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #555;
        }

        .auth-section-container {
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        /* 新增样式：用于列表视图 */
        .domainmap-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .domainmap-card {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .domainmap-card:hover {
            background-color: #3a3a3a;
        }
        
        .domainmap-card h3 {
            margin: 0 0 10px 0;
            color: #ffffff;
        }
        
        .domainmap-card p {
            margin: 5px 0;
            color: #cccccc;
            font-size: 14px;
        }
        
        .detail-view {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-section">
            <a href="#" class="logout" onclick="logout()">退出登录</a>
        </div>

        <h1>域名映射编辑器</h1>

        <div id="alert-container" class="hidden"></div>

        <!-- 列表视图 -->
        <div id="list-view">
            <div class="form-buttons">
                <button class="btn btn-success" onclick="switchToDetailView(-1)">添加域名映射</button>
                <button class="btn btn-warning" onclick="reloadConfig()">重新加载</button>
                <a href="{{.webPath}}" class="btn">返回首页</a>
            </div>
            
            <div id="domainmap-list" class="domainmap-list">
                <!-- DomainMap items will be dynamically added here -->
            </div>
            
            <div class="form-buttons">
                <button class="btn btn-success" onclick="switchToDetailView(-1)">添加域名映射</button>
                <button class="btn btn-warning" onclick="reloadConfig()">重新加载</button>
                <a href="{{.webPath}}" class="btn">返回首页</a>
            </div>
        </div>

        <!-- 详细视图 -->
        <div id="detail-view" class="detail-view">
            <div class="form-buttons">
                <button class="btn btn-warning" onclick="backToListView()">返回列表</button>
                <button class="btn btn-success" onclick="saveCurrentDomainMap()">保存</button>
                <a href="{{.webPath}}" class="btn">返回首页</a>
            </div>
            
            <div id="detail-form">
                <!-- 详细表单将在这里动态生成 -->
            </div>
            
            <div class="form-buttons">
                <button class="btn btn-warning" onclick="backToListView()">返回列表</button>
                <button class="btn btn-success" onclick="saveCurrentDomainMap()">保存</button>
                <a href="{{.webPath}}" class="btn">返回首页</a>
            </div>
        </div>
    </div>

    <script>
        const webPath = "{{.webPath}}";
        let domainMaps = [];
        let originalDomainMaps = []; // 用于跟踪原始配置
        let currentEditIndex = -1; // 当前编辑的索引，-1表示新增

        // 页面加载完成后获取配置
        window.addEventListener('load', function() {
            loadConfig();
        });

        // 格式化时间显示，去除多余的0部分
        function formatDuration(durationStr) {
            if (!durationStr) return '';
            
            // 移除末尾的0部分
            return durationStr.replace(/0[s|m|h]$/g, '').replace(/m0s$/g, 'm').replace(/h0m$/g, 'h').replace(/h0s$/g, 'h');
        }

        // 解析时间显示，用于表单显示
        function parseDuration(durationStr) {
            if (!durationStr) return '';
            // 使用formatDuration来格式化时间显示
            return formatDuration(durationStr);
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.className = `alert alert-${type}`;
            alertContainer.innerHTML = message;
            alertContainer.classList.remove('hidden');
            
            // 5秒后自动隐藏（给用户更多时间看到成功消息）
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }

        // 加载配置
        function loadConfig() {
            fetch(webPath + 'config/domainmap')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('加载配置失败');
                    }
                    return response.json();
                })
                .then(data => {
                    domainMaps = data || [];
                    originalDomainMaps = JSON.parse(JSON.stringify(domainMaps)); // 保存原始配置副本
                    renderDomainMapList();
                })
                .catch(error => {
                    console.error('加载配置失败:', error);
                    showAlert('加载配置失败: ' + error.message, 'danger');
                });
        }

        // 渲染域名映射列表
        function renderDomainMapList() {
            const container = document.getElementById('domainmap-list');
            container.innerHTML = '';
            
            // 渲染每个域名映射项为卡片
            domainMaps.forEach((domainMap, index) => {
                const cardElement = createDomainMapCard(domainMap, index);
                container.appendChild(cardElement);
            });
            
            // 显示列表视图，隐藏详细视图
            document.getElementById('list-view').style.display = 'block';
            document.getElementById('detail-view').style.display = 'none';
        }

        // 创建域名映射卡片元素
        function createDomainMapCard(domainMap, index) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'domainmap-card';
            cardDiv.innerHTML = `
                <h3>${domainMap.name || '未命名'}</h3>
                <p><strong>源域名:</strong> ${domainMap.source || '未设置'}</p>
                <p><strong>目标域名:</strong> ${domainMap.target || '未设置'}</p>
                <p><strong>协议:</strong> ${!domainMap.protocol ? '默认' : domainMap.protocol.toUpperCase()}</p>
            `;
            cardDiv.onclick = function() {
                switchToDetailView(index);
            };
            return cardDiv;
        }

        // 切换到详细视图
        function switchToDetailView(index) {
            currentEditIndex = index;
            renderDetailView();
            
            // 隐藏列表视图，显示详细视图
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
        }

        // 返回列表视图
        function backToListView() {
            renderDomainMapList();
        }

        // 渲染详细视图
        function renderDetailView() {
            const container = document.getElementById('detail-form');
            let domainMap;
            
            if (currentEditIndex === -1) {
                // 新增模式
                domainMap = {
                    name: '',
                    source: '',
                    target: '',
                    protocol: ''
                };
            } else {
                // 编辑模式
                domainMap = domainMaps[currentEditIndex];
            }
            
            // 检查是否有auth配置
            const hasAuth = domainMap.auth && (
                domainMap.auth.tokens_enabled || 
                domainMap.auth.token_param_name ||
                (domainMap.auth.dynamic_tokens && (domainMap.auth.dynamic_tokens.enable_dynamic || 
                                                 domainMap.auth.dynamic_tokens.dynamic_ttl || 
                                                 domainMap.auth.dynamic_tokens.secret || 
                                                 domainMap.auth.dynamic_tokens.salt)) ||
                (domainMap.auth.static_tokens && (domainMap.auth.static_tokens.enable_static || 
                                                domainMap.auth.static_tokens.token || 
                                                domainMap.auth.static_tokens.expire_hours))
            );
            
            // 如果auth存在但为空对象，则设置默认值
            if (domainMap.auth && typeof domainMap.auth === 'object') {
                if (typeof domainMap.auth.tokens_enabled === 'undefined') domainMap.auth.tokens_enabled = false;
                if (!domainMap.auth.token_param_name) domainMap.auth.token_param_name = '';
                if (!domainMap.auth.dynamic_tokens) domainMap.auth.dynamic_tokens = {};
                if (!domainMap.auth.static_tokens) domainMap.auth.static_tokens = {};
                if (typeof domainMap.auth.dynamic_tokens.enable_dynamic === 'undefined') domainMap.auth.dynamic_tokens.enable_dynamic = false;
                if (!domainMap.auth.dynamic_tokens.dynamic_ttl) domainMap.auth.dynamic_tokens.dynamic_ttl = '';
                if (!domainMap.auth.dynamic_tokens.secret) domainMap.auth.dynamic_tokens.secret = '';
                if (!domainMap.auth.dynamic_tokens.salt) domainMap.auth.dynamic_tokens.salt = '';
                if (typeof domainMap.auth.static_tokens.enable_static === 'undefined') domainMap.auth.static_tokens.enable_static = false;
                if (!domainMap.auth.static_tokens.token) domainMap.auth.static_tokens.token = '';
                if (!domainMap.auth.static_tokens.expire_hours) domainMap.auth.static_tokens.expire_hours = '';
            }

            container.innerHTML = `
                <div class="domainmap-item">
                    <div class="domainmap-item-header">
                        <span class="domainmap-item-title">${currentEditIndex === -1 ? '添加域名映射' : '编辑域名映射'}</span>
                        ${currentEditIndex !== -1 ? `<button class="btn btn-danger btn-sm" onclick="removeDomainMap(${currentEditIndex})">删除</button>` : ''}
                    </div>
                    <div class="form-group">
                        <label for="name">名称:</label>
                        <input type="text" id="name" class="form-control" value="${domainMap.name || ''}" onchange="updateCurrentDomainMap('name', this.value)">
                    </div>
                    <div class="form-group">
                        <label for="source">源域名:</label>
                        <input type="text" id="source" class="form-control" value="${domainMap.source || ''}" onchange="updateCurrentDomainMap('source', this.value)">
                    </div>
                    <div class="form-group">
                        <label for="target">目标域名:</label>
                        <input type="text" id="target" class="form-control" value="${domainMap.target || ''}" onchange="updateCurrentDomainMap('target', this.value)">
                    </div>
                    <div class="form-group">
                        <label for="protocol">协议:</label>
                        <select id="protocol" class="form-control" onchange="updateCurrentDomainMap('protocol', this.value)">
                            <option value="" ${!domainMap.protocol ? 'selected' : ''}>默认</option>
                            <option value="http" ${domainMap.protocol === 'http' ? 'selected' : ''}>HTTP</option>
                            <option value="https" ${domainMap.protocol === 'https' ? 'selected' : ''}>HTTPS</option>
                            <option value="rtsp" ${domainMap.protocol === 'rtsp' ? 'selected' : ''}>RTSP</option>
                        </select>
                    </div>
                    {{if .hasAuthConfig}}
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-auth" ${hasAuth ? 'checked' : ''} onchange="toggleAuthSection(this.checked)">
                            <label for="show-auth">启用认证配置</label>
                        </div>
                    </div>
                    <div id="auth-section" class="auth-section-container" style="display: ${hasAuth ? 'block' : 'none'};">
                        <div class="subsection">
                            <h3 class="subsection-title">认证配置</h3>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="auth-tokens-enabled" ${domainMap.auth && domainMap.auth.tokens_enabled ? 'checked' : ''} onchange="updateCurrentAuth('tokens_enabled', this.checked)">
                                    <label for="auth-tokens-enabled">启用 Token 认证</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="auth-token-param-name">Token 参数名:</label>
                                <input type="text" id="auth-token-param-name" class="form-control" value="${domainMap.auth && domainMap.auth.token_param_name ? domainMap.auth.token_param_name : ''}" onchange="updateCurrentAuth('token_param_name', this.value)">
                            </div>
                        </div>
                        
                        <div class="subsection">
                            <h3 class="subsection-title">动态 Token 配置</h3>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="auth-dynamic-enable-dynamic" ${domainMap.auth && domainMap.auth.dynamic_tokens && domainMap.auth.dynamic_tokens.enable_dynamic ? 'checked' : ''} onchange="updateCurrentAuthDynamicTokens('enable_dynamic', this.checked)">
                                    <label for="auth-dynamic-enable-dynamic">启用动态 Token</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="auth-dynamic-ttl">动态 Token 有效期:</label>
                                <input type="text" id="auth-dynamic-ttl" class="form-control" placeholder="例如: 1h" value="${domainMap.auth && domainMap.auth.dynamic_tokens && domainMap.auth.dynamic_tokens.dynamic_ttl ? parseDuration(domainMap.auth.dynamic_tokens.dynamic_ttl) : ''}" onchange="updateCurrentAuthDynamicTokens('dynamic_ttl', this.value)">
                            </div>
                            
                            <div class="form-group">
                                <label for="auth-dynamic-secret">AES 密钥:</label>
                                <input type="text" id="auth-dynamic-secret" class="form-control" value="${domainMap.auth && domainMap.auth.dynamic_tokens && domainMap.auth.dynamic_tokens.secret ? domainMap.auth.dynamic_tokens.secret : ''}" onchange="updateCurrentAuthDynamicTokens('secret', this.value)">
                            </div>
                            
                            <div class="form-group">
                                <label for="auth-dynamic-salt">Salt:</label>
                                <input type="text" id="auth-dynamic-salt" class="form-control" value="${domainMap.auth && domainMap.auth.dynamic_tokens && domainMap.auth.dynamic_tokens.salt ? domainMap.auth.dynamic_tokens.salt : ''}" onchange="updateCurrentAuthDynamicTokens('salt', this.value)">
                            </div>
                        </div>
                        
                        <div class="subsection">
                            <h3 class="subsection-title">静态 Token 配置</h3>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="auth-static-enable-static" ${domainMap.auth && domainMap.auth.static_tokens && domainMap.auth.static_tokens.enable_static ? 'checked' : ''} onchange="updateCurrentAuthStaticTokens('enable_static', this.checked)">
                                    <label for="auth-static-enable-static">启用静态 Token</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="auth-static-token">Token 值:</label>
                                <input type="text" id="auth-static-token" class="form-control" value="${domainMap.auth && domainMap.auth.static_tokens && domainMap.auth.static_tokens.token ? domainMap.auth.static_tokens.token : ''}" onchange="updateCurrentAuthStaticTokens('token', this.value)">
                            </div>
                            
                            <div class="form-group">
                                <label for="auth-static-expire-hours">过期时间:</label>
                                <input type="text" id="auth-static-expire-hours" class="form-control" placeholder="例如: 24h" value="${domainMap.auth && domainMap.auth.static_tokens && domainMap.auth.static_tokens.expire_hours ? parseDuration(domainMap.auth.static_tokens.expire_hours) : ''}" onchange="updateCurrentAuthStaticTokens('expire_hours', this.value)">
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
            `;
        }

        // 切换认证配置区域显示/隐藏
        function toggleAuthSection(show) {
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                authSection.style.display = show ? 'block' : 'none';
                
                // 如果是显示认证区域且当前domainMap没有auth属性，则初始化
                if (show) {
                    if (currentEditIndex === -1) {
                        // 新增模式
                        if (!domainMaps[currentEditIndex]) {
                            domainMaps[currentEditIndex] = {};
                        }
                        if (!domainMaps[currentEditIndex].auth || typeof domainMaps[currentEditIndex].auth !== 'object') {
                            domainMaps[currentEditIndex].auth = {
                                tokens_enabled: false,
                                token_param_name: '',
                                dynamic_tokens: {
                                    enable_dynamic: false,
                                    dynamic_ttl: '',
                                    secret: '',
                                    salt: ''
                                },
                                static_tokens: {
                                    enable_static: false,
                                    token: '',
                                    expire_hours: ''
                                }
                            };
                        }
                    } else {
                        // 编辑模式
                        if (!domainMaps[currentEditIndex].auth || typeof domainMaps[currentEditIndex].auth !== 'object') {
                            domainMaps[currentEditIndex].auth = {
                                tokens_enabled: false,
                                token_param_name: '',
                                dynamic_tokens: {
                                    enable_dynamic: false,
                                    dynamic_ttl: '',
                                    secret: '',
                                    salt: ''
                                },
                                static_tokens: {
                                    enable_static: false,
                                    token: '',
                                    expire_hours: ''
                                }
                            };
                        }
                    }
                }
                
                // 如果是隐藏认证区域，则删除auth属性
                if (!show) {
                    if (currentEditIndex === -1) {
                        // 新增模式
                        if (domainMaps[currentEditIndex] && domainMaps[currentEditIndex].auth) {
                            delete domainMaps[currentEditIndex].auth;
                        }
                    } else {
                        // 编辑模式
                        if (domainMaps[currentEditIndex].auth) {
                            delete domainMaps[currentEditIndex].auth;
                        }
                    }
                }
            }
        }

        // 更新当前编辑的域名映射属性
        function updateCurrentDomainMap(field, value) {
            if (currentEditIndex === -1) {
                // 新增模式
                if (!domainMaps[currentEditIndex]) {
                    domainMaps[currentEditIndex] = {};
                }
                domainMaps[currentEditIndex][field] = value;
            } else {
                // 编辑模式
                domainMaps[currentEditIndex][field] = value;
            }
        }

        // 更新当前编辑的认证配置
        function updateCurrentAuth(field, value) {
            if (currentEditIndex === -1) {
                // 新增模式
                if (!domainMaps[currentEditIndex]) {
                    domainMaps[currentEditIndex] = {};
                }
                if (!domainMaps[currentEditIndex].auth) {
                    domainMaps[currentEditIndex].auth = {};
                }
                domainMaps[currentEditIndex].auth[field] = value;
            } else {
                // 编辑模式
                if (!domainMaps[currentEditIndex].auth) {
                    domainMaps[currentEditIndex].auth = {};
                }
                domainMaps[currentEditIndex].auth[field] = value;
            }
        }

        // 更新当前编辑的动态Token配置
        function updateCurrentAuthDynamicTokens(field, value) {
            if (currentEditIndex === -1) {
                // 新增模式
                if (!domainMaps[currentEditIndex]) {
                    domainMaps[currentEditIndex] = {};
                }
                if (!domainMaps[currentEditIndex].auth) {
                    domainMaps[currentEditIndex].auth = {};
                }
                if (!domainMaps[currentEditIndex].auth.dynamic_tokens) {
                    domainMaps[currentEditIndex].auth.dynamic_tokens = {};
                }
                domainMaps[currentEditIndex].auth.dynamic_tokens[field] = value;
            } else {
                // 编辑模式
                if (!domainMaps[currentEditIndex].auth) {
                    domainMaps[currentEditIndex].auth = {};
                }
                if (!domainMaps[currentEditIndex].auth.dynamic_tokens) {
                    domainMaps[currentEditIndex].auth.dynamic_tokens = {};
                }
                domainMaps[currentEditIndex].auth.dynamic_tokens[field] = value;
            }
        }

        // 更新当前编辑的静态Token配置
        function updateCurrentAuthStaticTokens(field, value) {
            if (currentEditIndex === -1) {
                // 新增模式
                if (!domainMaps[currentEditIndex]) {
                    domainMaps[currentEditIndex] = {};
                }
                if (!domainMaps[currentEditIndex].auth) {
                    domainMaps[currentEditIndex].auth = {};
                }
                if (!domainMaps[currentEditIndex].auth.static_tokens) {
                    domainMaps[currentEditIndex].auth.static_tokens = {};
                }
                domainMaps[currentEditIndex].auth.static_tokens[field] = value;
            } else {
                // 编辑模式
                if (!domainMaps[currentEditIndex].auth) {
                    domainMaps[currentEditIndex].auth = {};
                }
                if (!domainMaps[currentEditIndex].auth.static_tokens) {
                    domainMaps[currentEditIndex].auth.static_tokens = {};
                }
                domainMaps[currentEditIndex].auth.static_tokens[field] = value;
            }
        }

        // 保存当前编辑的域名映射
        function saveCurrentDomainMap() {
            // 验证必填字段
            const dm = domainMaps[currentEditIndex];
            if (!dm.name || !dm.source || !dm.target) {
                showAlert(`名称、源域名和目标域名不能为空`, 'danger');
                return;
            }

            // 如果是新增模式，添加到数组中
            if (currentEditIndex === -1) {
                domainMaps.push(dm);
                currentEditIndex = domainMaps.length - 1;
            }

            // 保存配置
            saveConfig();
        }

        // 删除域名映射
        function removeDomainMap(index) {
            if (confirm('确定要删除这个域名映射吗？')) {
                domainMaps.splice(index, 1);
                backToListView();
                saveConfig(); // 删除后自动保存配置
            }
        }

        // 检查表单是否有未保存的更改
        function hasUnsavedChanges() {
            return JSON.stringify(domainMaps) !== JSON.stringify(originalDomainMaps);
        }

        // 保存配置
        function saveConfig() {
            // 验证必填字段
            for (let i = 0; i < domainMaps.length; i++) {
                const dm = domainMaps[i];
                if (!dm.name || !dm.source || !dm.target) {
                    showAlert(`域名映射 #${i + 1} 的名称、源域名和目标域名不能为空`, 'danger');
                    return;
                }
            }

            // 准备要发送的数据，清理空的auth配置
            const cleanDomainMaps = domainMaps.map(dm => {
                // 创建一个深拷贝以避免修改原始数据
                const cleaned = JSON.parse(JSON.stringify(dm));
                
                // 如果auth存在但为空或无效，则删除它
                if (cleaned.auth) {
                    const auth = cleaned.auth;
                    const hasValidAuth = auth.tokens_enabled || 
                                         auth.token_param_name ||
                                         (auth.dynamic_tokens && (auth.dynamic_tokens.enable_dynamic || 
                                                                 auth.dynamic_tokens.dynamic_ttl || 
                                                                 auth.dynamic_tokens.secret || 
                                                                 auth.dynamic_tokens.salt)) ||
                                         (auth.static_tokens && (auth.static_tokens.enable_static || 
                                                                auth.static_tokens.token || 
                                                                auth.static_tokens.expire_hours));
                    
                    if (!hasValidAuth) {
                        delete cleaned.auth;
                    }
                }
                
                return cleaned;
            });

            fetch(webPath + 'config/save-domainmap', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cleanDomainMaps)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || '保存失败');
                    });
                }
                return response.text();
            })
            .then(data => {
                originalDomainMaps = JSON.parse(JSON.stringify(domainMaps)); // 更新原始配置副本
                showAlert('配置保存成功,点击重新加载', 'success');
                // 保存成功后刷新列表
                loadConfig();
            })
            .catch(error => {
                console.error('保存配置失败:', error);
                showAlert('保存配置失败: ' + error.message, 'danger');
            });
        }

        // 重新加载配置
        function reloadConfig() {
            if (hasUnsavedChanges()) {
                if (confirm('确定要重新加载配置吗？未保存的更改将会丢失。')) {
                    loadConfig();
                    showAlert('配置已重新加载', 'success');
                }
            } else {
                loadConfig();
                showAlert('配置已重新加载', 'success');
            }
        }

        // 退出登录
        function logout() {
            if (hasUnsavedChanges()) {
                if (!confirm('有未保存的更改，确定要退出登录吗？')) {
                    return;
                }
            }
            
            fetch(webPath + 'logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = webPath + 'login';
            })
            .catch(error => {
                console.error('退出登录失败:', error);
                window.location.href = webPath + 'login';
            });
        }

        // 页面卸载前检查是否有未保存的更改
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>